---
import Layout from "../../layouts/Layout.astro";
import {
  getAllCheatsheets,
  getCheatsheetContent,
} from "../../utils/cheatsheets";
import { marked } from "marked";
import { getHighlighter } from "../../utils/highlighter";
import BookmarkButton from "../../components/BookmarkButton.astro";

export async function getStaticPaths() {
  const cheatsheets = getAllCheatsheets();
  return cheatsheets.map((sheet) => ({
    params: { slug: sheet.slug },
    props: { sheet },
  }));
}

const { sheet } = Astro.props;
const content = getCheatsheetContent(sheet.slug);

// Syntax highlighting configuration
const highlighter = await getHighlighter();

// Custom renderer for marked to use Shiki
const renderer = new marked.Renderer();

// Customizing code block rendering
renderer.code = function (token) {
  // Changed from (token) => { ... } to function(token) { ... }
  try {
    // Handle new marked signature (object as first arg)
    let code = "";
    let lang = "";

    if (typeof token === "object" && token !== null) {
      code = token.text || "";
      lang = token.lang || "";
    } else {
      // Fallback for older versions or unexpected calls
      code = token;
      lang = arguments[1]; // Now accessible since it's a function
    }

    lang = lang || "text";

    // Handle language aliases or unknown languages
    // Shiki might throw if language is unknown, so we should try-catch or normalize
    // But we have a try-catch block already.

    const html = highlighter.codeToHtml(code, {
      lang,
      themes: {
        light: "github-light",
        dark: "github-dark",
      },
      defaultColor: false,
    });

    return `<div class="relative group my-6 rounded-xl overflow-hidden border border-slate-200/50 dark:border-slate-700/50 bg-gradient-to-br from-slate-50 to-white dark:from-slate-900/80 dark:to-slate-900/80 backdrop-blur-sm shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-[1.02] bg-white/85 backdrop-blur-md backdrop-saturate-150 dark:bg-slate-900 dark:backdrop-blur-none dark:backdrop-filter-none dark:shadow-none">
                  <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-all duration-300 z-10 flex gap-2 animate-slide-in-right">
                     <span class="text-xs text-slate-400 font-inter font-medium py-1 px-2 bg-slate-100/80 dark:bg-slate-900 rounded-md backdrop-blur-sm">${lang}</span>
                     <button class="copy-btn bg-white/90 dark:bg-slate-900/90 border border-slate-200/50 dark:border-slate-600/50 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 p-1.5 rounded-lg text-xs font-medium shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105 font-inter" data-code="${encodeURIComponent(code)}">
                        Copy
                     </button>
                  </div>
                  <div class="code-block-wrapper overflow-x-auto p-6 text-sm leading-relaxed font-mono">
                    ${html}
                  </div>
                </div>`;
  } catch (e) {
    // Fallback to plain text if highlighting fails
    return `<pre class="bg-gradient-to-br from-slate-50 to-white dark:from-slate-900/80 dark:to-slate-900/80 border border-slate-200/50 dark:border-slate-700/50 p-6 rounded-xl backdrop-blur-sm shadow-sm overflow-x-auto text-sm leading-relaxed font-mono text-slate-900 dark:text-slate-100"><code>${token.text || token}</code></pre>`;
  }
};

// Customizing heading rendering to add anchor links
renderer.heading = function (text, level, raw) {
  // Handle new marked signature (object as first arg)
  if (typeof text === "object" && text !== null) {
    const token = text;
    text = token.text || "";
    level = token.depth || 1;
    raw = token.raw || "";
  }

  const slug = (raw || text || "")
    .toString()
    .toLowerCase()
    .replace(/[^\w]+/g, "-");

  return `
    <h${level} id="${slug}" class="group flex items-center scroll-mt-24 font-inter font-bold text-slate-900 dark:text-white transition-colors duration-200 hover:text-indigo-600 dark:hover:text-cyan-400">
      <a href="#${slug}" class="no-underline hover:underline text-inherit">
        ${text}
      </a>
      <a href="#${slug}" class="ml-2 opacity-0 group-hover:opacity-100 text-slate-400 hover:text-indigo-500 dark:hover:text-cyan-400 transition-all duration-200 transform translate-x-1 group-hover:translate-x-0" aria-label="Anchor">#</a>
    </h${level}>
  `;
};

marked.use({ renderer });

// Remove frontmatter from content if it exists (some Devhints might still have it in body if my parser didn't strip it perfectly, but my parser separated it. Wait, my parser in import-devhints.ts SAVED only body. So content should be clean markdown.)
const htmlContent = marked.parse(content);
---

<style>
  @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

  .font-inter {
    font-family: "Inter", "system-ui", "-apple-system", sans-serif;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 1s ease-out;
  }

  .animate-slide-up {
    animation: slideUp 0.8s ease-out forwards;
    opacity: 0;
  }

  .animate-slide-in-right {
    animation: slideInRight 0.6s ease-out forwards;
    opacity: 0;
  }

  /* Stagger delays */
  .stagger-0 {
    animation-delay: 0.1s;
  }
  .stagger-1 {
    animation-delay: 0.3s;
  }

  .stagger-item-0 {
    animation-delay: 0.1s;
  }
  .stagger-item-1 {
    animation-delay: 0.15s;
  }
  .stagger-item-2 {
    animation-delay: 0.2s;
  }
  .stagger-item-3 {
    animation-delay: 0.25s;
  }
  .stagger-item-4 {
    animation-delay: 0.3s;
  }

  /* Enhanced code block styling */
  .code-block-wrapper {
    scrollbar-width: thin;
    scrollbar-color: rgba(96, 165, 250, 0.3) transparent;
  }

  .code-block-wrapper::-webkit-scrollbar {
    height: 6px;
  }

  .code-block-wrapper::-webkit-scrollbar-track {
    background: transparent;
  }

  .code-block-wrapper::-webkit-scrollbar-thumb {
    background: linear-gradient(
      90deg,
      rgba(96, 165, 250, 0.6),
      rgba(236, 72, 153, 0.6)
    ); /* Blue to Pink */
    border-radius: 3px;
  }

  .code-block-wrapper::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(
      90deg,
      rgba(96, 165, 250, 0.8),
      rgba(236, 72, 153, 0.8)
    );
  }

  /* Enhanced prose styling */
  .prose blockquote {
    position: relative;
  }

  .prose blockquote::before {
    content: '"';
    position: absolute;
    left: -8px;
    top: -8px;
    font-size: 4rem;
    color: rgba(96, 165, 250, 0.1); /* Blue tint */
    font-family: "Inter", serif;
    line-height: 1;
  }

  /* Smooth transitions for all interactive elements */
  .prose a,
  .prose code,
  .prose strong {
    transition: all 0.2s ease;
  }

  .prose a:hover {
    color: rgb(59, 130, 246); /* Blue-500 */
  }

  .dark .prose a:hover {
    color: rgb(96, 165, 250); /* Blue-400 */
  }
</style>

<Layout
  title={`${sheet.meta.title} Cheatsheet`}
  description={`Cheatsheet for ${sheet.meta.title}. Quick reference and examples.`}
>
  <!-- Hero Section with Gradient Background -->
  <div class="relative overflow-hidden mb-8">
    <div
      class="absolute inset-0 bg-gradient-to-br from-indigo-50 via-white to-cyan-50 dark:from-slate-900 dark:via-slate-900 dark:to-slate-900 opacity-30"
    >
    </div>
    <div
      class="absolute inset-0 bg-gradient-to-r from-blue-500/3 via-purple-500/3 to-pink-500/3"
    >
    </div>

    <div class="relative max-w-4xl mx-auto px-4 py-8">
      <div
        class="mb-6 border-b border-slate-200/50 dark:border-slate-700/50 pb-6 animate-fade-in"
      >
        <div class="flex items-center justify-between mb-4">
          <div
            class="flex items-center space-x-2 text-sm text-slate-500 dark:text-slate-400 font-inter font-medium"
          >
            <a
              href="/"
              class="hover:text-indigo-600 dark:hover:text-blue-400 transition-colors duration-200"
              >Home</a
            >
            <span class="text-slate-300 dark:text-slate-600">/</span>
            <span class="text-slate-900 dark:text-slate-200"
              >{sheet.meta.category || "Cheatsheets"}</span
            >
          </div>
          <div class="flex items-center gap-3 animate-slide-in-right">
            <BookmarkButton
              slug={sheet.slug}
              title={sheet.meta.title}
              category={sheet.meta.category}
            />
            <a
              href={`https://github.com/rstacruz/cheatsheets/blob/master/${sheet.slug}.md`}
              target="_blank"
              class="text-xs font-medium text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 transition-all duration-200 border border-slate-200 dark:border-slate-700 px-3 py-1.5 rounded-full hover:bg-slate-50 dark:hover:bg-slate-800 hover:border-slate-300 dark:hover:border-slate-600 font-inter"
            >
              Edit on GitHub
            </a>
          </div>
        </div>

        <h1
          class="text-4xl md:text-5xl font-extrabold text-slate-900 dark:text-white tracking-tight mb-4 font-inter animate-slide-up"
        >
          <span
            class="bg-gradient-to-r from-blue-600 to-cyan-600 dark:from-blue-400 dark:to-cyan-400 bg-clip-text text-transparent"
            >{sheet.meta.title}</span
          >
        </h1>

        {
          sheet.meta.tags && sheet.meta.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 animate-slide-up stagger-1">
              {sheet.meta.tags.map((tag, index) => (
                <span
                  class={`px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-indigo-50 to-cyan-50 text-indigo-600 dark:from-blue-500/10 dark:to-cyan-500/10 dark:text-blue-300 border border-indigo-100 dark:border-blue-500/20 hover:scale-105 transition-all duration-200 font-inter animate-slide-in-right stagger-item-${index % 5}`}
                >
                  {tag}
                </span>
              ))}
            </div>
          )
        }
      </div>
    </div>
  </div>

  <!-- Main Content with Enhanced Styling -->
  <div class="max-w-4xl mx-auto px-4 pb-12">
    <!-- Removed glass class for dark mode via CSS override, but kept here for structure -->
    <article
      class="prose prose-slate dark:prose-invert max-w-none bg-white/85 backdrop-blur-md backdrop-saturate-150 border border-slate-200/30 dark:bg-slate-900 dark:border-none dark:backdrop-blur-none dark:backdrop-filter-none dark:shadow-none p-8 rounded-xl shadow-xl
        prose-headings:font-bold prose-headings:tracking-tight prose-headings:text-slate-900 dark:prose-headings:text-blue-400 prose-headings:font-inter
        prose-h1:text-3xl prose-h1:mt-12 prose-h1:mb-8 prose-h1:border-b prose-h1:border-slate-200 dark:prose-h1:border-slate-700 prose-h1:pb-3
        prose-h2:text-2xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:border-b prose-h2:border-slate-200 dark:prose-h2:border-slate-700 prose-h2:pb-2 prose-h2:text-indigo-600 dark:prose-h2:text-blue-400
        prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-4 prose-h3:text-slate-800 dark:prose-h3:text-blue-400
        prose-p:leading-7 prose-p:text-slate-600 dark:prose-p:text-slate-300 prose-p:font-inter
        prose-em:text-slate-500 dark:prose-em:text-slate-500 prose-em:font-inter
        prose-em:text-slate-500 dark:prose-em:text-slate-500 prose-em:font-inter
        prose-code:text-pink-600 dark:prose-code:text-pink-400 prose-code:bg-pink-50 dark:prose-code:bg-pink-500/10 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded-md prose-code:font-mono prose-code:text-sm prose-code:font-normal prose-code:before:content-none prose-code:after:content-none prose-code:transition-colors prose-code:duration-200
        prose-pre:bg-transparent prose-pre:p-0 prose-pre:m-0 prose-pre:border-0
        prose-strong:text-slate-900 dark:prose-strong:text-white prose-strong:font-inter
        prose-a:text-indigo-600 dark:prose-a:text-blue-400 prose-a:no-underline hover:prose-a:underline prose-a:transition-colors prose-a:duration-200
        prose-li:marker:text-slate-400 dark:prose-li:marker:text-slate-500 prose-li:font-inter
        prose-ul:space-y-2 prose-ol:space-y-2
        prose-blockquote:border-l-4 prose-blockquote:border-indigo-200 dark:prose-blockquote:border-blue-400 prose-blockquote:bg-indigo-50/50 dark:prose-blockquote:bg-transparent prose-blockquote:p-4 prose-blockquote:rounded-r-lg prose-blockquote:font-inter prose-blockquote:text-slate-700 dark:prose-blockquote:text-slate-400
        animate-fade-in"
    >
      <div set:html={htmlContent} />
    </article>
  </div>
</Layout>

<script>
  // Copy button functionality with enhanced animations
  document.querySelectorAll(".copy-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const button = btn as HTMLElement;
      const code = decodeURIComponent(button.getAttribute("data-code") || "");
      try {
        await navigator.clipboard.writeText(code);
        const originalText = button.textContent;
        const originalClasses = button.className;

        // Enhanced success animation
        button.textContent = "✓ Copied!";
        button.className = originalClasses.replace(
          "text-slate-500 hover:text-slate-700 dark:hover:text-slate-300",
          "text-green-600 dark:text-green-400 border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20",
        );
        button.style.transform = "scale(1.05)";

        setTimeout(() => {
          button.textContent = originalText;
          button.className = originalClasses;
          button.style.transform = "";
        }, 2000);
      } catch (err) {
        console.error("Failed to copy", err);
        // Error state
        const originalText = button.textContent;
        button.textContent = "❌ Failed";
        button.className = button.className.replace(
          "text-slate-500",
          "text-red-600 dark:text-red-400",
        );

        setTimeout(() => {
          button.textContent = originalText;
          button.className = button.className.replace(
            "text-red-600 dark:text-red-400",
            "text-slate-500",
          );
        }, 2000);
      }
    });
  });

  // Add smooth scrolling for anchor links
  document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
    anchor.addEventListener("click", function (e) {
      e.preventDefault();
      const link = e.currentTarget as HTMLAnchorElement;
      const href = link.getAttribute("href");
      if (href) {
        const target = document.querySelector(href);
        if (target) {
          target.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      }
    });
  });
</script>
