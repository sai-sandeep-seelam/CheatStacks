---
import { getAllCheatsheets } from '../utils/cheatsheets';
import SearchBar from './SearchBar.astro';

const cheatsheets = getAllCheatsheets();

// Group by category
const categories = cheatsheets.reduce((acc, sheet) => {
    const cat = sheet.meta.category || 'Other';
    if (!acc[cat]) acc[cat] = [];
    acc[cat].push(sheet);
    return acc;
}, {} as Record<string, typeof cheatsheets>);

const sortedCategories = Object.keys(categories).sort();
---

<aside id="sidebar" class="fixed top-16 bottom-0 left-0 z-40 w-72 bg-white dark:bg-slate-900 border-r border-gray-200 dark:border-gray-800 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col lg:static lg:h-screen lg:sticky lg:top-16">
  <!-- Sticky mobile search section -->
  <div class="lg:hidden sticky top-0 z-10 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-gray-800 p-4">
    <SearchBar />
  </div>

  <!-- Scrollable content section -->
  <div class="flex-1 overflow-y-auto p-4 lg:p-6 min-h-0">
    <nav class="space-y-8">
      {sortedCategories.map(category => (
        <div>
          <h3 class="font-bold text-sm uppercase tracking-wider text-slate-900 dark:text-slate-200 mb-3 px-2">{category}</h3>
          <ul class="space-y-0.5">
            {categories[category].map(sheet => (
              <li>
                <a href={`/cheatsheets/${sheet.slug}`} class="block px-2 py-1.5 text-sm text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 rounded-md transition-colors truncate">
                  {sheet.meta.title}
                </a>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </nav>
  </div>

  <!-- Fixed mobile footer: Login/Profile -->
  <div class="lg:hidden border-t border-gray-200 dark:border-gray-800 p-3 bg-white dark:bg-slate-900">
    <!-- Login button (shown when not logged in) -->
    <a id="mobile-login-link" href="/login" class="block px-3 py-1.5 text-sm font-medium text-center text-white bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 rounded-md transition-colors">Login</a>
    
    <!-- Profile section (shown when logged in) -->
    <div id="mobile-profile-section" class="hidden">
      <button id="mobile-profile-trigger" class="w-full flex items-center gap-2 p-1.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-md transition-colors">
        <img id="mobile-profile-img" src="" alt="Profile" class="w-7 h-7 rounded-full hidden">
        <div id="mobile-profile-icon" class="w-7 h-7 rounded-full bg-slate-300 dark:bg-slate-600 flex items-center justify-center text-slate-700 dark:text-slate-300 hidden flex-shrink-0">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div class="flex-1 text-left">
          <p id="mobile-username" class="text-xs font-medium text-slate-900 dark:text-white truncate">User</p>
        </div>
        <svg class="w-3.5 h-3.5 text-slate-500 dark:text-slate-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
      
      <div id="mobile-profile-menu" class="hidden mt-1.5 bg-slate-50 dark:bg-slate-800 rounded-md border border-slate-200 dark:border-slate-700">
        <a href="/profile" class="block px-2.5 py-1.5 text-xs text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-t-md">Change Profile</a>
        <a href="/account" class="block px-2.5 py-1.5 text-xs text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">Account Info</a>
        <button id="mobile-logout-btn" class="w-full text-left px-2.5 py-1.5 text-xs text-red-600 dark:text-red-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-b-md">Logout</button>
      </div>
    </div>
  </div>
</aside>

<div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/50 z-30 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

<script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const menuButton = document.getElementById('menu-button');

    // Mobile profile elements
    const mobileLoginLink = document.getElementById('mobile-login-link');
    const mobileProfileSection = document.getElementById('mobile-profile-section');
    const mobileProfileImg = document.getElementById('mobile-profile-img');
    const mobileProfileIcon = document.getElementById('mobile-profile-icon');
    const mobileUsername = document.getElementById('mobile-username');
    const mobileProfileTrigger = document.getElementById('mobile-profile-trigger');
    const mobileProfileMenu = document.getElementById('mobile-profile-menu');
    const mobileLogoutBtn = document.getElementById('mobile-logout-btn');

    function toggleSidebar() {
      if (!sidebar) return;
      const isHidden = sidebar.classList.contains('-translate-x-full');
      sidebar.classList.toggle('-translate-x-full');
      overlay?.classList.toggle('hidden');
      document.body.classList.toggle('overflow-hidden');
      if (menuButton) menuButton.setAttribute('aria-expanded', String(isHidden));
    }

    function updateMobileProfile() {
      const loggedIn = localStorage.getItem('loggedIn') === 'true';
      const user = localStorage.getItem('user');
      const profilePic = localStorage.getItem('image') || localStorage.getItem('profilePic');

      if (loggedIn && user) {
        mobileLoginLink?.classList.add('hidden');
        mobileProfileSection?.classList.remove('hidden');
        if (mobileUsername) mobileUsername.textContent = user;

        if (profilePic && mobileProfileImg instanceof HTMLImageElement) {
          mobileProfileImg.src = profilePic;
          mobileProfileImg.onerror = function() { this.src = 'https://www.w3schools.com/w3images/avatar2.png'; };
          mobileProfileImg.classList.remove('hidden');
          mobileProfileIcon?.classList.add('hidden');
        } else if (mobileProfileIcon) {
          mobileProfileIcon.classList.remove('hidden');
          mobileProfileImg?.classList.add('hidden');
        }
      } else {
        mobileLoginLink?.classList.remove('hidden');
        mobileProfileSection?.classList.add('hidden');
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', updateMobileProfile);

    // Toggle mobile profile dropdown
    mobileProfileTrigger?.addEventListener('click', function() {
      mobileProfileMenu?.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const target = e.target as HTMLElement;
      if (mobileProfileSection && !mobileProfileSection.contains(target)) {
        mobileProfileMenu?.classList.add('hidden');
      }
    });

    // Mobile logout
    mobileLogoutBtn?.addEventListener('click', function() {
      localStorage.removeItem('loggedIn');
      localStorage.removeItem('user');
      localStorage.removeItem('email');
      localStorage.removeItem('image');
      window.location.href = '/login';
    });

    menuButton?.addEventListener('click', toggleSidebar);
    overlay?.addEventListener('click', toggleSidebar);
</script>
